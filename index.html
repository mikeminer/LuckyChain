<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LuckyChain – SuperEnalotto On-Chain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>

<style>
    body {
        background: #0f0f0f;
        color: #ffffff;
        font-family: Arial, sans-serif;
        padding: 30px;
        max-width: 800px;
        margin: auto;
    }
    h1 { color: #00d4ff; }
    .card {
        border: 1px solid #00d4ff;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    button {
        background: #00d4ff;
        color: black;
        border: none;
        padding: 10px 18px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }
    input {
        width: 60px;
        padding: 5px;
        margin-right: 5px;
        text-align: center;
    }
    .label { color: #00d4ff; font-weight: bold; }
    .small { font-size: 0.8rem; opacity: 0.8; }
    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #00d4ff66;
        font-size: 0.7rem;
        margin-top: 4px;
    }
    .winner-number {
        background: #00d4ff;
        color: #000;
        padding: 6px 10px;
        border-radius: 999px;
        margin: 3px;
        display: inline-block;
        font-weight: bold;
    }
</style>
</head>

<body>

<h1>LuckyChain – SuperEnalotto On-Chain</h1>
<p>Your Lucky Moment, Secured by Blockchain</p>

<div class="card">
    <button id="connectBtn">Connect Wallet</button>
    <p id="account"></p>
    <p id="network"></p>
    <p class="small badge">Target: Base Sepolia (chainId 84532)</p>
</div>

<div class="card">
    <h2>Buy a Ticket (1 USDC)</h2>
    <p>Select 6 numbers (1–90), 1 Jolly, 1 Superstar</p>

    <div>
        <label class="label">Numbers:</label><br>
        <input id="n1" type="number" min="1" max="90">
        <input id="n2" type="number" min="1" max="90">
        <input id="n3" type="number" min="1" max="90">
        <input id="n4" type="number" min="1" max="90">
        <input id="n5" type="number" min="1" max="90">
        <input id="n6" type="number" min="1" max="90">
    </div>

    <div>
        <label class="label">Jolly:</label>
        <input id="jolly" type="number" min="1" max="90">
    </div>

    <div>
        <label class="label">Superstar:</label>
        <input id="superstar" type="number" min="1" max="90">
    </div>

    <button id="buyBtn" disabled>Buy Ticket</button>
    <p class="small">
        Use test USDC (<code>0x036CbD53842c5426634e7929541eC2318f3dCF7e</code>) on Base Sepolia
        and approve 1 USDC to this contract.
    </p>
</div>

<div class="card">
    <h2>Round Status</h2>
    <p><span class="label">Current Round:</span> <span id="round"></span></p>
    <p><span class="label">Tickets Sold:</span> <span id="ticketCount"></span> / 100</p>
    <p><span class="label">Jackpot:</span> <span id="jackpot"></span> USDC</p>
    <p><span class="label">Round Drawn?</span> <span id="finished"></span></p>
</div>

<div class="card">
    <h2>Winning Numbers (Current Round)</h2>
    <p><span class="label">Numbers:</span> <span id="wn"></span></p>
    <p><span class="label">Jolly:</span> <span id="wj"></span></p>
    <p><span class="label">Superstar:</span> <span id="ws"></span></p>
</div>

<div class="card">
    <h2>Last Draw</h2>
    <p><span class="label">Round:</span> <span id="lastRound"></span></p>
    <p><span class="label">Numbers:</span> <span id="lastWn"></span></p>
    <p><span class="label">Jolly:</span> <span id="lastWj"></span></p>
    <p><span class="label">Superstar:</span> <span id="lastWs"></span></p>
</div>

<p id="status" class="small"></p>

<script>
/* -------------------------------------------------------------
   CONFIG – ADDRESS DEL TUO CONTRATTO SU BASE SEPOLIA
------------------------------------------------------------- */

const CONTRACT_ADDRESS = "0x33736a45DdFF374E9c3bab66D76C1B3B8292def0";

/* -------------------------------------------------------------
   GLOBALS
------------------------------------------------------------- */

let provider, signer, contract, contractInterface;

function $(id) { return document.getElementById(id); }
function setStatus(msg) { $("status").innerText = msg || ""; }

/* -------------------------------------------------------------
   ABI DYNAMIC FROM BLOCKSCOUT
------------------------------------------------------------- */

async function loadAbiFromBlockscout() {
    const url = `https://base-sepolia.blockscout.com/api?module=contract&action=getabi&address=${CONTRACT_ADDRESS}`;
    console.log("Fetching ABI from:", url);
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.status !== "1") {
        console.error("Blockscout ABI error:", data);
        throw new Error("Blockscout ABI error: " + data.result);
    }
    const abi = JSON.parse(data.result);
    console.log("ABI loaded from Blockscout:", abi);
    return abi;
}

/* -------------------------------------------------------------
   CONNECT WALLET
------------------------------------------------------------- */

$("connectBtn").onclick = async () => {
    try {
        if (!window.ethereum) {
            alert("Please install MetaMask.");
            return;
        }

        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        const addr = await signer.getAddress();
        $("account").innerText = "Connected: " + addr;

        const net = await provider.getNetwork();
        const chainId = Number(net.chainId);
        $("network").innerText = "Chain ID: " + chainId;

        if (chainId !== 84532) {
            setStatus("Please switch MetaMask to Base Sepolia (chainId 84532).");
            contract = null;
            $("buyBtn").disabled = true;
            return;
        }

        setStatus("Connected on Base Sepolia. Loading ABI from Blockscout...");
        const abi = await loadAbiFromBlockscout();
        contract = new ethers.Contract(CONTRACT_ADDRESS, abi, signer);
        contractInterface = contract.interface;

        $("buyBtn").disabled = false;
        setStatus("Ready.");

        await updateUI();
    } catch (e) {
        console.error(e);
        setStatus("Failed to connect / load ABI. See console.");
    }
};

/* -------------------------------------------------------------
   DETECT SUPPORTO FUNZIONI (NUOVO vs VECCHIO STILE)
------------------------------------------------------------- */

function hasFunction(name) {
    if (!contractInterface) return false;
    try {
        contractInterface.getFunction(name);
        return true;
    } catch {
        return false;
    }
}

/* -------------------------------------------------------------
   UPDATE UI (ROUND + WINNING + LAST DRAW)
------------------------------------------------------------- */

async function updateUI() {
    if (!contract) {
        console.warn("No contract instance. Make sure you're on Base Sepolia and ABI loaded.");
        return;
    }

    try {
        setStatus("Loading round data...");

        // 1) Prova prima lo stile NUOVO: getCurrentRoundInfo() / getLastDrawInfo()
        if (hasFunction("getCurrentRoundInfo")) {
            console.log("Using NEW style getCurrentRoundInfo/getLastDrawInfo");
            const info = await contract.getCurrentRoundInfo();
            // (roundId, ticketsSold, currentJackpot, isDrawn, nums[6], jolly, superstar)
            const roundId        = info[0];
            const ticketsSold    = info[1];
            const currentJackpot = info[2];
            const isDrawn        = info[3];
            const nums           = info[4];
            const jolly          = info[5];
            const superstar      = info[6];

            $("round").innerText       = roundId.toString();
            $("ticketCount").innerText = ticketsSold.toString();
            $("jackpot").innerText     = (Number(currentJackpot) / 1e6).toFixed(2);
            $("finished").innerText    = isDrawn ? "YES" : "NO";

            if (isDrawn) {
                $("wn").innerText = Array.from(nums).join(", ");
                $("wj").innerText = jolly.toString();
                $("ws").innerText = superstar.toString();
            } else {
                $("wn").innerText = "-";
                $("wj").innerText = "-";
                $("ws").innerText = "-";
            }

            if (hasFunction("getLastDrawInfo")) {
                const last = await contract.getLastDrawInfo();
                // (roundId, nums[6], jolly, superstar, drawn)
                const lastRoundId = last[0];
                const lastNums    = last[1];
                const lastJolly   = last[2];
                const lastSuper   = last[3];
                const lastDrawn   = last[4];

                if (lastDrawn && (lastRoundId !== 0n && lastRoundId !== 0)) {
                    $("lastRound").innerText = lastRoundId.toString();
                    $("lastWn").innerText    = Array.from(lastNums).join(", ");
                    $("lastWj").innerText    = lastJolly.toString();
                    $("lastWs").innerText    = lastSuper.toString();
                } else {
                    $("lastRound").innerText = "-";
                    $("lastWn").innerText    = "-";
                    $("lastWj").innerText    = "-";
                    $("lastWs").innerText    = "-";
                }
            } else {
                $("lastRound").innerText = "-";
                $("lastWn").innerText    = "-";
                $("lastWj").innerText    = "-";
                $("lastWs").innerText    = "-";
            }

            setStatus("");
            return;
        }

        // 2) FALLBACK: vecchio stile, variabili pubbliche:
        //    currentRound(), ticketCount(), jackpot(), roundFinished(),
        //    winningNumbers[...] / winningJolly() / winningSuperstar()
        console.log("Using OLD style public variables");

        let roundId = 0n;
        let ticketsSold = 0n;
        let currentJackpot = 0n;
        let isDrawn = false;

        if (hasFunction("currentRound")) {
            roundId = await contract.currentRound();
        }
        if (hasFunction("ticketCount")) {
            ticketsSold = await contract.ticketCount();
        } else if (hasFunction("ticketsInCurrentRound")) {
            ticketsSold = await contract.ticketsInCurrentRound();
        }

        if (hasFunction("jackpot")) {
            currentJackpot = await contract.jackpot();
        }

        if (hasFunction("roundFinished")) {
            isDrawn = await contract.roundFinished();
        }

        $("round").innerText       = roundId.toString();
        $("ticketCount").innerText = ticketsSold.toString();
        $("jackpot").innerText     = (Number(currentJackpot) / 1e6).toFixed(2);
        $("finished").innerText    = isDrawn ? "YES" : "NO";

        // winningNumbers: se è public uint8[6], getter è winningNumbers(uint256) -> uint8
        // se è in una struct RoundResult, abbiamo usato ramo NEW, quindi qui prevediamo la versione semplice
        let numsArr = [];
        if (hasFunction("winningNumbers")) {
            try {
                // Proviamo se esiste come funzione che ritorna array intero (pochi compiler)
                const maybeArray = await contract.winningNumbers();
                if (Array.isArray(maybeArray)) {
                    numsArr = Array.from(maybeArray);
                }
            } catch (e) {
                // fallback: public fixed array -> indicizzata
                numsArr = [];
                for (let i = 0; i < 6; i++) {
                    try {
                        const n = await contract.winningNumbers(i);
                        numsArr.push(Number(n));
                    } catch {}
                }
            }
        }

        if (numsArr.length > 0 && isDrawn) {
            $("wn").innerText = numsArr.join(", ");
        } else {
            $("wn").innerText = "-";
        }

        if (hasFunction("winningJolly")) {
            const j = await contract.winningJolly();
            $("wj").innerText = Number(j).toString();
        } else {
            $("wj").innerText = "-";
        }

        if (hasFunction("winningSuperstar")) {
            const s = await contract.winningSuperstar();
            $("ws").innerText = Number(s).toString();
        } else {
            $("ws").innerText = "-";
        }

        // last draw: se c'è lastDrawnRound + roundResults(round)
        if (hasFunction("lastDrawnRound") && hasFunction("roundResults")) {
            const lastRoundId = await contract.lastDrawnRound();
            if (lastRoundId === 0n || lastRoundId === 0) {
                $("lastRound").innerText = "-";
                $("lastWn").innerText    = "-";
                $("lastWj").innerText    = "-";
                $("lastWs").innerText    = "-";
            } else {
                $("lastRound").innerText = lastRoundId.toString();
                const lastRes = await contract.roundResults(lastRoundId);
                // speriamo che la struct sia compatibile: (bool drawn, uint8[6], uint8, uint8)
                const lastNums  = lastRes[1];
                const lastJolly = lastRes[2];
                const lastSuper = lastRes[3];

                $("lastWn").innerText = Array.from(lastNums).join(", ");
                $("lastWj").innerText = Number(lastJolly).toString();
                $("lastWs").innerText = Number(lastSuper).toString();
            }
        } else {
            $("lastRound").innerText = "-";
            $("lastWn").innerText    = "-";
            $("lastWj").innerText    = "-";
            $("lastWs").innerText    = "-";
        }

        setStatus("");
    } catch (e) {
        console.error("updateUI error:", e);
        setStatus("Failed to load round data. See console.");
    }
}

/* -------------------------------------------------------------
   BUY TICKET
------------------------------------------------------------- */

$("buyBtn").onclick = async () => {
    if (!contract) {
        alert("Connect wallet on Base Sepolia first.");
        return;
    }

    if (!hasFunction("buyTicket")) {
        alert("This contract does not expose buyTicket(uint8[6],uint8,uint8) in ABI.");
        return;
    }

    const nums = [
        Number($("n1").value),
        Number($("n2").value),
        Number($("n3").value),
        Number($("n4").value),
        Number($("n5").value),
        Number($("n6").value),
    ];
    const j = Number($("jolly").value);
    const s = Number($("superstar").value);

    // basic validation
    const seen = new Set();
    for (let i = 0; i < 6; i++) {
        const v = nums[i];
        if (!Number.isInteger(v) || v < 1 || v > 90) {
            alert("All 6 main numbers must be between 1 and 90.");
            return;
        }
        if (seen.has(v)) {
            alert("Main numbers must be distinct.");
            return;
        }
        seen.add(v);
    }
    if (!Number.isInteger(j) || j < 1 || j > 90) {
        alert("Jolly must be between 1 and 90.");
        return;
    }
    if (!Number.isInteger(s) || s < 1 || s > 90) {
        alert("Superstar must be between 1 and 90.");
        return;
    }

    try {
        setStatus("Sending transaction...");
        const tx = await contract.buyTicket(nums, j, s);
        alert("Ticket purchased! Tx: " + tx.hash);
        await tx.wait();
        setStatus("Ticket confirmed on-chain.");
        await updateUI();
    } catch (e) {
        console.error("buyTicket error:", e);
        setStatus("Error buying ticket. Check console.");
        alert("Error buying ticket.");
    }
};

/* -------------------------------------------------------------
   AUTO-RELOAD ON CHAIN CHANGE
------------------------------------------------------------- */
if (window.ethereum) {
    window.ethereum.on("chainChanged", () => {
        window.location.reload();
    });
}
</script>

</body>
</html>
