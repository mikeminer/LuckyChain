<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LuckyChain ‚Äì SuperEnalotto On-Chain</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        background: radial-gradient(circle at top, #0a0a0a 10%, #000 70%);
        color: #fff;
        font-family: 'Montserrat', sans-serif;
        text-align: center;
        padding: 30px;
    }
    h1 {
        font-size: 3rem;
        text-shadow: 0 0 15px #00eaff;
    }
    select, button, input {
        padding: 12px;
        margin: 8px;
        border-radius: 10px;
        border: none;
        font-size: 16px;
    }
    button {
        background: #00eaff;
        color: #000;
        cursor: pointer;
        transition: 0.2s;
        font-weight: 700;
    }
    button:hover {
        transform: scale(1.05);
        background: #00bcd4;
    }
    .panel {
        background: rgba(255,255,255,0.07);
        padding: 20px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        margin: 20px auto;
        box-shadow: 0 0 15px #00eaff55;
    }
    .numbers input {
        width: 55px;
        font-size: 18px;
        text-align: center;
    }
    .winner-number {
        background: #00eaff;
        color: #000;
        padding: 8px 12px;
        border-radius: 10px;
        margin: 4px;
        display: inline-block;
        font-weight: bold;
        font-size: 20px;
        box-shadow: 0 0 10px #00eaff;
    }
</style>
</head>
<body>

<h1>LuckyChain üíé</h1>
<p>‚ÄúYour Lucky Moment, Secured by Blockchain‚Äù</p>

<div class="panel">
    <h2>1Ô∏è‚É£ Connect Wallet</h2>
    <button onclick="connectWallet()">Connect</button>
</div>

<div class="panel">
    <h2>2Ô∏è‚É£ Select Network</h2>
    <select id="networkSelector" onchange="switchNetwork()">
        <option value="baseSepolia">Base Sepolia</option>
        <option value="baseMainnet">Base Mainnet</option>
        <option value="opSepolia">Optimism Sepolia</option>
        <option value="opMainnet">Optimism Mainnet</option>
    </select>
</div>

<div class="panel">
    <h2>3Ô∏è‚É£ Buy Ticket (1 USDC)</h2>
    <div class="numbers">
        <input id="n1" type="number" min="1" max="90">
        <input id="n2" type="number" min="1" max="90">
        <input id="n3" type="number" min="1" max="90">
        <input id="n4" type="number" min="1" max="90">
        <input id="n5" type="number" min="1" max="90">
        <input id="n6" type="number" min="1" max="90">
    </div>

    <p>Jolly: <input id="jolly" type="number" min="1" max="90"></p>
    <p>Superstar: <input id="superstar" type="number" min="1" max="90"></p>

    <button onclick="buyTicket()">Buy Ticket</button>
</div>

<div class="panel">
    <h2>4Ô∏è‚É£ Current Round</h2>
    <p><b>Round:</b> <span id="roundId">-</span></p>
    <p><b>Tickets Sold:</b> <span id="ticketsSold">-</span></p>
    <p><b>Jackpot:</b> <span id="jackpot">-</span> USDC</p>
    <p><b>Drawn:</b> <span id="drawn">-</span></p>

    <div id="winningNumbers"></div>

    <button onclick="loadRound()">Refresh</button>
</div>

<div class="panel">
    <h2>5Ô∏è‚É£ Last Draw</h2>
    <p><b>Round:</b> <span id="lastRoundId">-</span></p>
    <div id="lastWinningNumbers"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.min.js"></script>
<script>

// -----------------------------
// CONTRACT ADDRESSES
// -----------------------------

const ADDR = {
    baseSepolia: "0x33736a45DdFF374E9c3bab66D76C1B3B8292def0",
    baseMainnet: "0x0000000000000000000000000000000000000000",
    opSepolia:   "0x0000000000000000000000000000000000000000",
    opMainnet:   "0x0000000000000000000000000000000000000000"
};

// -----------------------------
// ABI (CORRETTA)
// -----------------------------

const ABI = [
    "function buyTicket(uint8[6] nums, uint8 jolly, uint8 superstar)",
    "function getCurrentRoundInfo() view returns (uint256,uint256,uint256,bool,uint8[6],uint8,uint8)",
    "function getLastDrawInfo() view returns (uint256,uint8[6],uint8,uint8,bool)"
];

let provider;
let signer;
let contract;

// -----------------------------
// Connect Wallet
// -----------------------------
async function connectWallet() {
    if (!window.ethereum) {
        return alert("Install MetaMask.");
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    alert("Wallet connected!");
    initContract();
}

// -----------------------------
// Switch Network
// -----------------------------
function initContract() {
    const net = document.getElementById("networkSelector").value;
    const address = ADDR[net];
    if (!address) return alert("Invalid network.");
    contract = new ethers.Contract(address, ABI, signer);
}

async function switchNetwork() {
    const selected = document.getElementById("networkSelector").value;

    const chainData = {
        baseSepolia:  { chainId: "0x14A34", rpc: "https://base-sepolia.blockpi.network/v1/rpc/public" },
        baseMainnet:  { chainId: "0x2105" },
        opSepolia:    { chainId: "0xAAF0" },
        opMainnet:    { chainId: "0xA" }
    };

    const { chainId } = chainData[selected];

    await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId }]
    });

    initContract();
}

// -----------------------------
// Buy Ticket
// -----------------------------
async function buyTicket() {
    const nums = [
        parseInt(n1.value),
        parseInt(n2.value),
        parseInt(n3.value),
        parseInt(n4.value),
        parseInt(n5.value),
        parseInt(n6.value),
    ];

    const j = parseInt(jolly.value);
    const s = parseInt(superstar.value);

    const tx = await contract.buyTicket(nums, j, s);
    await tx.wait();

    alert("Ticket bought!");
}

// -----------------------------
// Load Round Info
// -----------------------------
async function loadRound() {
    try {
        const data = await contract.getCurrentRoundInfo();

        document.getElementById("roundId").textContent = data[0];
        document.getElementById("ticketsSold").textContent = data[1];
        document.getElementById("jackpot").textContent = (Number(data[2]) / 1e6).toFixed(2);
        document.getElementById("drawn").textContent = data[3] ? "YES" : "NO";

        const nums = data[4];

        let html = "";
        for (let n of nums) {
            html += `<span class="winner-number">${n}</span>`;
        }
        document.getElementById("winningNumbers").innerHTML = html;

        loadLastDraw();
    } catch (err) {
        console.error(err);
        alert("Failed to load round data.");
    }
}

// -----------------------------
// Load Last Draw Info
// -----------------------------
async function loadLastDraw() {
    const data = await contract.getLastDrawInfo();

    document.getElementById("lastRoundId").textContent = data[0];

    let html = "";
    for (let n of data[1]) {
        html += `<span class="winner-number">${n}</span>`;
    }
    html += `<br>Jolly: ${data[2]} ‚Ä¢ Superstar: ${data[3]}`;

    document.getElementById("lastWinningNumbers").innerHTML = html;
}

</script>

</body>
</html>
