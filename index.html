<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LuckyChain ‚Äì Base Sepolia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: radial-gradient(circle at top, #101020 0, #02020a 60%, #000 100%);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      text-align: center;
      padding: 30px 10px;
    }
    h1 {
      font-size: 2.5rem;
      text-shadow: 0 0 18px #00eaffaa;
      margin-bottom: 0.4rem;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 0.7rem;
    }
    p {
      margin: 6px 0;
    }
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.85;
      margin-bottom: 1.5rem;
    }
    .panel {
      background: rgba(17, 25, 40, 0.9);
      border-radius: 18px;
      padding: 18px 16px;
      margin: 16px auto;
      max-width: 520px;
      box-shadow: 0 0 18px rgba(0, 234, 255, 0.22);
      border: 1px solid rgba(0, 234, 255, 0.2);
    }
    button,
    input {
      font-size: 15px;
      border-radius: 12px;
      border: none;
      padding: 10px 14px;
      margin: 6px 4px;
    }
    button {
      background: linear-gradient(135deg, #00eaff, #00bcd4);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(0, 234, 255, 0.7);
      transition: transform 0.15s ease, box-shadow 0.15s ease,
        filter 0.15s ease;
    }
    button:hover {
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 0 20px rgba(0, 234, 255, 0.9);
      filter: brightness(1.05);
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .numbers-row input {
      width: 54px;
      text-align: center;
      font-size: 16px;
    }
    .small {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .winner-number {
      background: #00eaff;
      color: #000;
      padding: 6px 10px;
      border-radius: 999px;
      margin: 3px;
      display: inline-block;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 0 10px #00eaffaa;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.08);
      margin-top: 4px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.85rem;
      opacity: 0.9;
      min-height: 1.1em;
    }
  </style>
</head>
<body>
  <h1>LuckyChain üíé</h1>
  <p class="subtitle">
    SuperEnalotto-style 6/90 ‚Ä¢ Base Sepolia ‚Ä¢ 1 USDC per ticket
  </p>

  <div class="panel">
    <h2>1Ô∏è‚É£ Connect Wallet</h2>
    <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
    <p id="walletInfo" class="small">Not connected</p>
    <p class="small tag">Network: Base Sepolia (chainId 84532)</p>
  </div>

  <div class="panel">
    <h2>2Ô∏è‚É£ Buy Ticket (1 USDC)</h2>
    <p class="small">
      Pick 6 distinct numbers between 1 and 90, plus Jolly & Superstar.
    </p>
    <div class="numbers-row">
      <input id="n1" type="number" min="1" max="90" placeholder="n1" />
      <input id="n2" type="number" min="1" max="90" placeholder="n2" />
      <input id="n3" type="number" min="1" max="90" placeholder="n3" />
      <input id="n4" type="number" min="1" max="90" placeholder="n4" />
      <input id="n5" type="number" min="1" max="90" placeholder="n5" />
      <input id="n6" type="number" min="1" max="90" placeholder="n6" />
    </div>
    <p>
      Jolly:
      <input
        id="jolly"
        type="number"
        min="1"
        max="90"
        placeholder="J"
        style="width: 70px"
      />
      Superstar:
      <input
        id="superstar"
        type="number"
        min="1"
        max="90"
        placeholder="S"
        style="width: 90px"
      />
    </p>
    <button id="buyBtn" onclick="buyTicket()" disabled>Buy Ticket</button>
    <p class="small">
      Make sure you hold test USDC
      (<code>0x036CbD53842c5426634e7929541eC2318f3dCF7e</code>) on Base
      Sepolia and have approved the contract to spend 1 USDC.
    </p>
  </div>

  <div class="panel">
    <h2>3Ô∏è‚É£ Current Round</h2>
    <p><b>Round:</b> <span id="roundId">-</span></p>
    <p><b>Tickets Sold:</b> <span id="ticketsSold">-</span></p>
    <p><b>Jackpot:</b> <span id="jackpot">-</span> USDC</p>
    <p><b>Drawn:</b> <span id="drawn">-</span></p>

    <div id="winningNumbers"></div>
    <p id="currentExtra" class="small"></p>

    <button onclick="loadRoundInfo()">Refresh Round</button>
  </div>

  <div class="panel">
    <h2>4Ô∏è‚É£ Last Draw</h2>
    <p><b>Round:</b> <span id="lastRoundId">-</span></p>
    <div id="lastWinningNumbers"></div>
  </div>

  <p id="status"></p>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.min.js"></script>
  <script>
    // -----------------------------
    // CONFIG
    // -----------------------------

    // ‚¨áÔ∏è METTI QUI L'ADDRESS DEL TUO CONTRATTO LuckyChainVRF_BaseSepolia ‚¨áÔ∏è
    const CONTRACT_ADDRESS = "0x33736a45DdFF374E9c3bab66D76C1B3B8292def0"; // sostituisci se diverso

    // ABI perfettamente allineata al contratto che hai postato
    const LUCKYCHAIN_ABI = [
      "function buyTicket(uint8[6] nums, uint8 jolly, uint8 superstar)",
      "function getCurrentRoundInfo() view returns (uint256 roundId, uint256 ticketsSold, uint256 currentJackpot, bool isDrawn, uint8[6] nums, uint8 jolly, uint8 superstar)",
      "function getLastDrawInfo() view returns (uint256 roundId, uint8[6] nums, uint8 jolly, uint8 superstar, bool drawn)"
    ];

    let provider = null;
    let signer = null;
    let contract = null;

    function $(id) {
      return document.getElementById(id);
    }

    function setStatus(msg) {
      $("status").textContent = msg || "";
    }

    // -----------------------------
    // CONNECT WALLET + NETWORK
    // -----------------------------

    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert("Please install MetaMask.");
          return;
        }

        setStatus("Connecting wallet...");
        await window.ethereum.request({ method: "eth_requestAccounts" });

        // ethers v6
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const addr = await signer.getAddress();

        $("walletInfo").textContent = `Connected: ${addr}`;
        $("buyBtn").disabled = false;
        setStatus("Wallet connected.");

        // ensure Base Sepolia (chainId 84532 -> 0x14A34)
        await ensureBaseSepolia();
        initContract();
        await loadRoundInfo();
      } catch (err) {
        console.error("connectWallet error:", err);
        setStatus("Failed to connect wallet. Check console.");
      }
    }

    async function ensureBaseSepolia() {
      const targetChainIdHex = "0x14A34"; // 84532

      try {
        const current = await provider.send("eth_chainId", []);
        if (current !== targetChainIdHex) {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: targetChainIdHex }]
          });
          setStatus("Switched to Base Sepolia.");
        }
      } catch (err) {
        console.warn("Network switch error:", err);
        setStatus("Please switch MetaMask to Base Sepolia (chainId 84532).");
      }
    }

    function initContract() {
      if (!signer) {
        console.warn("Signer not ready yet.");
        return;
      }
      contract = new ethers.Contract(CONTRACT_ADDRESS, LUCKYCHAIN_ABI, signer);
    }

    // -----------------------------
    // BUY TICKET
    // -----------------------------

    async function buyTicket() {
      if (!contract) {
        alert("Contract not initialized. Connect wallet first.");
        return;
      }

      const nums = [
        parseInt($("n1").value),
        parseInt($("n2").value),
        parseInt($("n3").value),
        parseInt($("n4").value),
        parseInt($("n5").value),
        parseInt($("n6").value)
      ];
      const j = parseInt($("jolly").value);
      const s = parseInt($("superstar").value);

      // validations
      const seen = new Set();
      for (let i = 0; i < 6; i++) {
        const v = nums[i];
        if (isNaN(v) || v < 1 || v > 90) {
          alert("All 6 main numbers must be between 1 and 90.");
          return;
        }
        if (seen.has(v)) {
          alert("Main numbers must be distinct.");
          return;
        }
        seen.add(v);
      }

      if (isNaN(j) || j < 1 || j > 90) {
        alert("Jolly must be between 1 and 90.");
        return;
      }
      if (isNaN(s) || s < 1 || s > 90) {
        alert("Superstar must be between 1 and 90.");
        return;
      }

      try {
        setStatus("Sending transaction to buy ticket...");
        const tx = await contract.buyTicket(nums, j, s);
        await tx.wait();
        setStatus("Ticket bought successfully!");
        await loadRoundInfo();
      } catch (err) {
        console.error("buyTicket error:", err);
        setStatus("Transaction failed. Check console for details.");
      }
    }

    // -----------------------------
    // LOAD CURRENT ROUND
    // -----------------------------

    async function loadRoundInfo() {
      if (!contract) {
        console.warn("No contract instance. Connect wallet first.");
        return;
      }

      try {
        setStatus("Loading current round...");
        const res = await contract.getCurrentRoundInfo();

        const roundId = res[0];
        const ticketsSold = res[1];
        const currentJackpot = res[2];
        const isDrawn = res[3];
        const nums = res[4];
        const jolly = res[5];
        const superstar = res[6];

        $("roundId").textContent = roundId.toString();
        $("ticketsSold").textContent = ticketsSold.toString();
        $("jackpot").textContent = (Number(currentJackpot) / 1e6).toFixed(2);
        $("drawn").textContent = isDrawn ? "YES" : "NO";

        let html = "";
        if (isDrawn) {
          for (let n of nums) {
            html += `<span class="winner-number">${n}</span>`;
          }
          $("currentExtra").textContent = `Jolly: ${jolly} ‚Ä¢ Superstar: ${superstar}`;
        } else {
          html = `<span class="small">No draw yet for this round.</span>`;
          $("currentExtra").textContent = "";
        }
        $("winningNumbers").innerHTML = html;

        await loadLastDrawInfo();
        setStatus("");
      } catch (err) {
        console.error("loadRoundInfo error:", err);
        setStatus("Failed to load round data. See console.");
      }
    }

    // -----------------------------
    // LOAD LAST DRAW
    // -----------------------------

    async function loadLastDrawInfo() {
      if (!contract) return;

      try {
        const res = await contract.getLastDrawInfo();
        const roundId = res[0];
        const nums = res[1];
        const jolly = res[2];
        const superstar = res[3];
        const drawn = res[4];

        if (!drawn || roundId === 0n || roundId === 0) {
          $("lastRoundId").textContent = "-";
          $("lastWinningNumbers").innerHTML =
            '<span class="small">No draws yet.</span>';
          return;
        }

        $("lastRoundId").textContent = roundId.toString();
        let html = "";
        for (let n of nums) {
          html += `<span class="winner-number">${n}</span>`;
        }
        html += `<div class="small">Jolly: ${jolly} ‚Ä¢ Superstar: ${superstar}</div>`;
        $("lastWinningNumbers").innerHTML = html;
      } catch (err) {
        console.error("loadLastDrawInfo error:", err);
      }
    }

    // -----------------------------
    // HANDLE CHAIN CHANGE
    // -----------------------------
    if (window.ethereum) {
      window.ethereum.on("chainChanged", () => {
        // re-init provider/signer/contract
        connectWallet().catch(console.error);
      });
    }
  </script>
</body>
</html>
