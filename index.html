<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LuckyChain – SuperEnalotto On-Chain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>

<style>
    body {
        background: #0f0f0f;
        color: #ffffff;
        font-family: Arial, sans-serif;
        padding: 30px;
        max-width: 800px;
        margin: auto;
    }
    h1 { color: #00d4ff; }
    .card {
        border: 1px solid #00d4ff;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    button {
        background: #00d4ff;
        color: black;
        border: none;
        padding: 10px 18px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }
    input {
        width: 60px;
        padding: 5px;
        margin-right: 5px;
        text-align: center;
    }
    .label { color: #00d4ff; font-weight: bold; }
    .small { font-size: 0.8rem; opacity: 0.8; }
    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #00d4ff66;
        font-size: 0.7rem;
        margin-top: 4px;
    }
    .winner-number {
        background: #00d4ff;
        color: #000;
        padding: 6px 10px;
        border-radius: 999px;
        margin: 3px;
        display: inline-block;
        font-weight: bold;
    }
</style>
</head>

<body>

<h1>LuckyChain – SuperEnalotto On-Chain</h1>
<p>Your Lucky Moment, Secured by Blockchain</p>

<div class="card">
    <button id="connectBtn">Connect Wallet</button>
    <p id="account"></p>
    <p id="network"></p>
    <p class="small badge">Network: Base Sepolia (chainId 84532)</p>
</div>

<div class="card">
    <h2>Buy a Ticket (1 USDC)</h2>
    <p>Select 6 numbers (1–90), 1 Jolly, 1 Superstar</p>

    <div>
        <label class="label">Numbers:</label><br>
        <input id="n1" type="number" min="1" max="90">
        <input id="n2" type="number" min="1" max="90">
        <input id="n3" type="number" min="1" max="90">
        <input id="n4" type="number" min="1" max="90">
        <input id="n5" type="number" min="1" max="90">
        <input id="n6" type="number" min="1" max="90">
    </div>

    <div>
        <label class="label">Jolly:</label>
        <input id="jolly" type="number" min="1" max="90">
    </div>

    <div>
        <label class="label">Superstar:</label>
        <input id="superstar" type="number" min="1" max="90">
    </div>

    <button id="buyBtn" disabled>Buy Ticket</button>
    <p class="small">
        Make sure you hold test USDC (<code>0x036CbD53842c5426634e7929541eC2318f3dCF7e</code>)
        on Base Sepolia and approved 1 USDC to this contract.
    </p>
</div>

<div class="card">
    <h2>Round Status</h2>
    <p><span class="label">Current Round:</span> <span id="round"></span></p>
    <p><span class="label">Tickets Sold:</span> <span id="ticketCount"></span> / 100</p>
    <p><span class="label">Jackpot:</span> <span id="jackpot"></span> USDC</p>
    <p><span class="label">Round Drawn?</span> <span id="finished"></span></p>
</div>

<div class="card">
    <h2>Winning Numbers (Current Round)</h2>
    <p><span class="label">Numbers:</span> <span id="wn"></span></p>
    <p><span class="label">Jolly:</span> <span id="wj"></span></p>
    <p><span class="label">Superstar:</span> <span id="ws"></span></p>
</div>

<div class="card">
    <h2>Last Draw</h2>
    <p><span class="label">Round:</span> <span id="lastRound"></span></p>
    <p><span class="label">Numbers:</span> <span id="lastWn"></span></p>
    <p><span class="label">Jolly:</span> <span id="lastWj"></span></p>
    <p><span class="label">Superstar:</span> <span id="lastWs"></span></p>
</div>

<p id="status" class="small"></p>

<script>
/* -------------------------------------------------------------
   CONFIG – METTI QUI L’ADDRESS DEL TUO CONTRATTO
   (LuckyChainVRF_BaseSepolia su Base Sepolia)
------------------------------------------------------------- */

const CONTRACT_ADDRESS = "0x33736a45DdFF374E9c3bab66D76C1B3B8292def0"; // cambia se hai un altro deploy

/* -------------------------------------------------------------
   ABI DEL CONTRATTO (ALLINEATA AL TUO SOL)
------------------------------------------------------------- */

const ABI = [
    "function buyTicket(uint8[6] nums, uint8 jolly, uint8 superstar)",
    "function getCurrentRoundInfo() view returns (uint256 roundId, uint256 ticketsSold, uint256 currentJackpot, bool isDrawn, uint8[6] nums, uint8 jolly, uint8 superstar)",
    "function getLastDrawInfo() view returns (uint256 roundId, uint8[6] nums, uint8 jolly, uint8 superstar, bool drawn)"
];

/* -------------------------------------------------------------
   GLOBALS
------------------------------------------------------------- */

let provider, signer, contract;

/* -------------------------------------------------------------
   HELPERS
------------------------------------------------------------- */

function $(id) { return document.getElementById(id); }

function setStatus(msg) {
    $("status").innerText = msg || "";
}

/* -------------------------------------------------------------
   CONNECT WALLET
------------------------------------------------------------- */

$("connectBtn").onclick = async () => {
    try {
        if (!window.ethereum) {
            alert("Please install MetaMask.");
            return;
        }

        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        const addr = await signer.getAddress();
        $("account").innerText = "Connected: " + addr;

        const net = await provider.getNetwork();
        const chainId = Number(net.chainId);
        $("network").innerText = "Chain ID: " + chainId;

        if (chainId !== 84532) {
            setStatus("Please switch MetaMask to Base Sepolia (chainId 84532).");
        } else {
            setStatus("Connected on Base Sepolia.");
        }

        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        $("buyBtn").disabled = false;

        await updateUI();
    } catch (e) {
        console.error(e);
        setStatus("Failed to connect wallet.");
    }
};

/* -------------------------------------------------------------
   UPDATE UI (ROUND STATUS + WINNING NUMBERS + LAST DRAW)
------------------------------------------------------------- */

async function updateUI() {
    if (!contract) return;

    try {
        setStatus("Loading round info...");

        const info = await contract.getCurrentRoundInfo();
        // info = [roundId, ticketsSold, currentJackpot, isDrawn, nums[6], jolly, superstar]

        const roundId        = info[0];
        const ticketsSold    = info[1];
        const currentJackpot = info[2];
        const isDrawn        = info[3];
        const nums           = info[4];
        const jolly          = info[5];
        const superstar      = info[6];

        $("round").innerText       = roundId.toString();
        $("ticketCount").innerText = ticketsSold.toString();
        $("jackpot").innerText     = (Number(currentJackpot) / 1e6).toFixed(2);
        $("finished").innerText    = isDrawn ? "YES" : "NO";

        if (isDrawn) {
            $("wn").innerText = Array.from(nums).join(", ");
            $("wj").innerText = jolly.toString();
            $("ws").innerText = superstar.toString();
        } else {
            $("wn").innerText = "-";
            $("wj").innerText = "-";
            $("ws").innerText = "-";
        }

        // Last draw info
        const last = await contract.getLastDrawInfo();
        // last = [roundId, nums[6], jolly, superstar, drawn]
        const lastRoundId = last[0];
        const lastNums    = last[1];
        const lastJolly   = last[2];
        const lastSuper   = last[3];
        const lastDrawn   = last[4];

        if (lastDrawn && (lastRoundId !== 0n && lastRoundId !== 0)) {
            $("lastRound").innerText = lastRoundId.toString();
            $("lastWn").innerText    = Array.from(lastNums).join(", ");
            $("lastWj").innerText    = lastJolly.toString();
            $("lastWs").innerText    = lastSuper.toString();
        } else {
            $("lastRound").innerText = "-";
            $("lastWn").innerText    = "-";
            $("lastWj").innerText    = "-";
            $("lastWs").innerText    = "-";
        }

        setStatus("");
    } catch (e) {
        console.error(e);
        setStatus("Failed to load round data.");
    }
}

/* -------------------------------------------------------------
   BUY TICKET
------------------------------------------------------------- */

$("buyBtn").onclick = async () => {
    if (!contract) {
        alert("Connect wallet first.");
        return;
    }

    const nums = [
        Number($("n1").value),
        Number($("n2").value),
        Number($("n3").value),
        Number($("n4").value),
        Number($("n5").value),
        Number($("n6").value),
    ];
    const j = Number($("jolly").value);
    const s = Number($("superstar").value);

    // basic validation
    const seen = new Set();
    for (let i = 0; i < 6; i++) {
        const v = nums[i];
        if (!Number.isInteger(v) || v < 1 || v > 90) {
            alert("All 6 main numbers must be between 1 and 90.");
            return;
        }
        if (seen.has(v)) {
            alert("Main numbers must be distinct.");
            return;
        }
        seen.add(v);
    }
    if (!Number.isInteger(j) || j < 1 || j > 90) {
        alert("Jolly must be between 1 and 90.");
        return;
    }
    if (!Number.isInteger(s) || s < 1 || s > 90) {
        alert("Superstar must be between 1 and 90.");
        return;
    }

    try {
        setStatus("Sending transaction...");
        const tx = await contract.buyTicket(nums, j, s);
        alert("Ticket purchased! Tx: " + tx.hash);
        await tx.wait();
        setStatus("Ticket confirmed on-chain.");
        await updateUI();
    } catch (e) {
        console.error(e);
        setStatus("Error buying ticket. Check console.");
        alert("Error buying ticket.");
    }
};

/* -------------------------------------------------------------
   OPTIONAL: AUTO-REFRESH ON CHAIN CHANGE
------------------------------------------------------------- */

if (window.ethereum) {
    window.ethereum.on("chainChanged", () => {
        window.location.reload();
    });
}
</script>

</body>
</html>
